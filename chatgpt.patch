From f96aa17da6c1d116540f70146229018d20a9c8f2 Mon Sep 17 00:00:00 2001
From: Codex <codex@openai.com>
Date: Fri, 16 Jan 2026 17:40:08 +0000
Subject: [PATCH] Add gearbox torque column to tables and CSVs
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

### Motivation
- Surface computed gearbox torque (tension × radius ÷ (gr2 × motor count)) in results so users can inspect gearbox loading per wrap and per layer.
- Expose gearbox torque in table renderers and CSV exports to allow detection of exceedances against a user-provided gearbox limit.
- Ensure UI highlights values that exceed the configured gearbox max torque.

### Description
- Compute per-wrap `gearbox_torque_Nm` in `src/js/main.mjs` as `drum_torque_required / (gr2_safe * motors_safe)` and add `gr2_safe` guard.
- Compute per-layer `max_gearbox_torque_Nm` in `src/js/electric.mjs` using a `gearboxDenom` and include it in layer rows.
- Add `gearbox_torque_Nm`/`max_gearbox_torque_Nm` fields to the projected electric and hydraulic wrap/layer datasets and include them in CSV column lists in `src/js/main.mjs`.
- Extend `renderElectricTables()` signature to accept `gearboxMaxTorqueNm` and render a gearbox torque column in both the electric layer and wraps tables using a `torqueCell()` helper that applies `class="is-exceeded"` and a `title` when the value exceeds the provided gearbox max.
- Add gearbox torque columns/headers to `src/index.html` for the electric and hydraulic layer/wrap tables.
- Render gearbox torque values in hydraulic tables and aggregate a per-layer `max_gearbox_torque_Nm` in `src/js/hydraulic.mjs`.
- Add `.is-exceeded` styling in `src/css/styles.css` for visual emphasis of exceedances.

### Testing
- Started the local server with `npm start` and the server reported "Server listening on http://localhost:3000", which succeeded.
- Attempted an automated UI smoke test with Playwright to capture a screenshot of the updated electric table, but Chromium crashed with a SIGSEGV / `TargetClosedError`, so no screenshot was produced.
- No other automated tests were executed as part of this change.
---
 src/css/styles.css   |  7 +++-
 src/index.html       | 12 +++++++
 src/js/electric.mjs  | 78 ++++++++++++++++++++++++++------------------
 src/js/hydraulic.mjs |  9 +++++
 src/js/main.mjs      | 27 ++++++++++-----
 5 files changed, 91 insertions(+), 42 deletions(-)

diff --git a/src/css/styles.css b/src/css/styles.css
index 066e865..8413768 100644
--- a/src/css/styles.css
+++ b/src/css/styles.css
@@ -697,6 +697,12 @@ button:focus {
   text-align: center;
 }
 
+.is-exceeded {
+  color: #b64242;
+  background: #fdecec;
+  font-weight: 600;
+}
+
 .tab-bar {
   display: flex;
   flex-wrap: wrap;
@@ -1188,4 +1194,3 @@ th[title] {
     width: auto;
   }
 }
-
diff --git a/src/index.html b/src/index.html
index 4578d2e..b46ea72 100644
--- a/src/index.html
+++ b/src/index.html
@@ -1007,6 +1007,9 @@
               <th title="tau_avail_kNm">
                 <span data-latex="\\tau_{avail}">τ<sub>avail</sub></span><br>(kN·m)
               </th>
+              <th title="max_gearbox_torque_Nm">
+                <span data-latex="\\tau_{g}">τ<sub>g</sub></span><br>(N·m)
+              </th>
               <th title="max_motor_torque_Nm">
                 <span data-latex="\\tau_{m,\\max}">τ<sub>m,max</sub></span><br>(N·m)
               </th>
@@ -1063,6 +1066,9 @@
                 <th title="tau_avail_kNm">
                   <span data-latex="\\tau_{avail}">τ<sub>avail</sub></span><br>(kN·m)
                 </th>
+                <th title="gearbox_torque_Nm">
+                  <span data-latex="\\tau_{g}">τ<sub>g</sub></span><br>(N·m)
+                </th>
                 <th title="motor_torque_Nm">
                   <span data-latex="\\tau_{m}">τ<sub>m</sub></span><br>(N·m)
                 </th>
@@ -1119,6 +1125,9 @@
               <th title="hyd_tau_avail_kNm">
                 <span data-latex="\\tau_{avail}">τ<sub>avail</sub></span><br>(kN·m)
               </th>
+              <th title="max_gearbox_torque_Nm">
+                <span data-latex="\\tau_{g}">τ<sub>g</sub></span><br>(N·m)
+              </th>
               <th title="hyd_tension_theoretical_start_kgf">
                 <span data-latex="T_{theo}">T<sub>theo</sub></span><br>(kgf)
               </th>
@@ -1184,6 +1193,9 @@
                 <th title="hyd_tau_avail_kNm">
                   <span data-latex="\\tau_{avail}">τ<sub>avail</sub></span><br>(kN·m)
                 </th>
+                <th title="gearbox_torque_Nm">
+                  <span data-latex="\\tau_{g}">τ<sub>g</sub></span><br>(N·m)
+                </th>
                 <th title="hyd_avail_tension_kgf">
                   <span data-latex="T_{avail}">T<sub>avail</sub></span><br>(kgf)
                 </th>
diff --git a/src/js/electric.mjs b/src/js/electric.mjs
index 12002e6..decc15d 100644
--- a/src/js/electric.mjs
+++ b/src/js/electric.mjs
@@ -75,6 +75,7 @@ export function rowsToElectricLayer(rows, payload_kg, cable_w_kgpm, gr1, gr2, mo
   // Final: compute max tension/torque values at the layer start (pre-wrap)
   const out = [];
   const denom = (gr1 || 1) * (gr2 || 1) * (motors || 1);
+  const gearboxDenom = Math.max(gr2 || 1, 1e-9) * Math.max(motors || 1, 1);
 
   for (const L of [...byLayer.values()].sort((a, b) => a.layer_no - b.layer_no)) {
     const maxTheo_kgf = tension_kgf(L.pre_deployed_m, payload_kg, cable_w_kgpm);
@@ -82,6 +83,7 @@ export function rowsToElectricLayer(rows, payload_kg, cable_w_kgpm, gr1, gr2, mo
     const radius_m = (L.layer_dia_in * M_PER_IN) / 2;
     const maxT_Nm = +(maxReq_kgf * G * radius_m).toFixed(1);
     const maxMotorNm = +(maxT_Nm / denom).toFixed(1);
+    const maxGearboxNm = +(maxT_Nm / gearboxDenom).toFixed(1);
 
     out.push({
       ...L,
@@ -89,6 +91,7 @@ export function rowsToElectricLayer(rows, payload_kg, cable_w_kgpm, gr1, gr2, mo
       max_tension_required_kgf: maxReq_kgf,
       max_torque_Nm: maxT_Nm,
       tau_avail_kNm: +(maxT_Nm / 1000).toFixed(1),
+      max_gearbox_torque_Nm: maxGearboxNm,
       max_motor_torque_Nm: maxMotorNm
     });
   }
@@ -113,6 +116,7 @@ export function projectElectricWraps(rows) {
     tension_required_kgf: r.tension_kgf,
     tension_theoretical_kgf: r.tension_theoretical_kgf,
     tau_avail_kNm: +(r.torque_Nm / 1000).toFixed(1),
+    gearbox_torque_Nm: r.gearbox_torque_Nm,
     motor_torque_Nm: r.motor_torque_Nm,
     motor_rpm: r.motor_rpm,
     line_speed_mpm: r.line_speed_mpm,
@@ -127,29 +131,38 @@ export function projectElectricWraps(rows) {
  * @param {HTMLElement} tbodyLayer
  * @param {HTMLElement} tbodyWraps
  */
-export function renderElectricTables(elLayers, elWraps, tbodyLayer, tbodyWraps) {
+export function renderElectricTables(elLayers, elWraps, tbodyLayer, tbodyWraps, gearboxMaxTorqueNm) {
+  const hasGearboxMax = Number.isFinite(gearboxMaxTorqueNm) && gearboxMaxTorqueNm > 0;
+  const torqueCell = (value) => {
+    const text = formatMotorTorque(value);
+    const exceeds = hasGearboxMax && Number.isFinite(value) && value > gearboxMaxTorqueNm;
+    const attrs = exceeds ? ' class="is-exceeded" title="Exceeds gearbox max torque"' : '';
+    return `<td${attrs}>${text}</td>`;
+  };
+
   // Layer table
   tbodyLayer.innerHTML = '';
   for (const r of elLayers) {
     const tr = document.createElement('tr');
     const cells = [
-      formatInteger(r.layer_no),
-      formatInches(r.layer_dia_in),
-      formatMeters(r.pre_on_drum_m),
-      formatMeters(r.pre_deployed_m),
-      formatMeters(r.post_on_drum_m),
-      formatMeters(r.post_deployed_m),
-      formatKgf(r.max_tension_theoretical_kgf),
-      formatKgf(r.max_tension_required_kgf),
-      formatDecimal(r.tau_avail_kNm, 1),
-      formatMotorTorque(r.max_motor_torque_Nm),
-      formatRpm(r.motor_rpm_at_start ?? ''),
-      formatSpeed(r.line_speed_at_start_mpm ?? ''),
-      formatKgf(r.tension_theoretical_start_kgf),
-      formatKgf(r.tension_required_start_kgf),
-      formatKgf(r.avail_tension_kgf)
+      `<td>${formatInteger(r.layer_no)}</td>`,
+      `<td>${formatInches(r.layer_dia_in)}</td>`,
+      `<td>${formatMeters(r.pre_on_drum_m)}</td>`,
+      `<td>${formatMeters(r.pre_deployed_m)}</td>`,
+      `<td>${formatMeters(r.post_on_drum_m)}</td>`,
+      `<td>${formatMeters(r.post_deployed_m)}</td>`,
+      `<td>${formatKgf(r.max_tension_theoretical_kgf)}</td>`,
+      `<td>${formatKgf(r.max_tension_required_kgf)}</td>`,
+      `<td>${formatDecimal(r.tau_avail_kNm, 1)}</td>`,
+      torqueCell(r.max_gearbox_torque_Nm),
+      `<td>${formatMotorTorque(r.max_motor_torque_Nm)}</td>`,
+      `<td>${formatRpm(r.motor_rpm_at_start ?? '')}</td>`,
+      `<td>${formatSpeed(r.line_speed_at_start_mpm ?? '')}</td>`,
+      `<td>${formatKgf(r.tension_theoretical_start_kgf)}</td>`,
+      `<td>${formatKgf(r.tension_required_start_kgf)}</td>`,
+      `<td>${formatKgf(r.avail_tension_kgf)}</td>`
     ];
-    tr.innerHTML = cells.map(v => `<td>${v}</td>`).join('');
+    tr.innerHTML = cells.join('');
     tbodyLayer.appendChild(tr);
   }
 
@@ -158,22 +171,23 @@ export function renderElectricTables(elLayers, elWraps, tbodyLayer, tbodyWraps)
   for (const r of elWraps) {
     const tr = document.createElement('tr');
     const cells = [
-      formatInteger(r.wrap_no),
-      formatInteger(r.layer_no),
-      formatInches(r.layer_dia_in),
-      formatInches(r.wrap_len_in),
-      formatMeters(r.pre_spooled_len_m),
-      formatMeters(r.spooled_len_m),
-      formatMeters(r.deployed_len_m),
-      formatKgf(r.tension_theoretical_kgf ?? ''),
-      formatKgf(r.tension_required_kgf ?? ''),
-      formatDecimal(r.tau_avail_kNm, 1),
-      formatMotorTorque(r.motor_torque_Nm),
-      formatRpm(r.motor_rpm),
-      formatSpeed(r.line_speed_mpm),
-      formatKgf(r.avail_tension_kgf)
+      `<td>${formatInteger(r.wrap_no)}</td>`,
+      `<td>${formatInteger(r.layer_no)}</td>`,
+      `<td>${formatInches(r.layer_dia_in)}</td>`,
+      `<td>${formatInches(r.wrap_len_in)}</td>`,
+      `<td>${formatMeters(r.pre_spooled_len_m)}</td>`,
+      `<td>${formatMeters(r.spooled_len_m)}</td>`,
+      `<td>${formatMeters(r.deployed_len_m)}</td>`,
+      `<td>${formatKgf(r.tension_theoretical_kgf ?? '')}</td>`,
+      `<td>${formatKgf(r.tension_required_kgf ?? '')}</td>`,
+      `<td>${formatDecimal(r.tau_avail_kNm, 1)}</td>`,
+      torqueCell(r.gearbox_torque_Nm),
+      `<td>${formatMotorTorque(r.motor_torque_Nm)}</td>`,
+      `<td>${formatRpm(r.motor_rpm)}</td>`,
+      `<td>${formatSpeed(r.line_speed_mpm)}</td>`,
+      `<td>${formatKgf(r.avail_tension_kgf)}</td>`
     ];
-    tr.innerHTML = cells.map(v => `<td>${v}</td>`).join('');
+    tr.innerHTML = cells.join('');
     tbodyWraps.appendChild(tr);
   }
 }
diff --git a/src/js/hydraulic.mjs b/src/js/hydraulic.mjs
index dadb9ad..178f09a 100644
--- a/src/js/hydraulic.mjs
+++ b/src/js/hydraulic.mjs
@@ -45,6 +45,7 @@ export function rowsToHydraulicLayer(rows) {
         hyd_hp_sys: null,
         hyd_tau_avail_Nm: null,
         hyd_tau_avail_kNm: null,
+        max_gearbox_torque_Nm: null,
         hyd_tension_theoretical_start_kgf: null,
         hyd_tension_required_start_kgf: null,
         hyd_avail_tension_kgf: null
@@ -74,6 +75,11 @@ export function rowsToHydraulicLayer(rows) {
       L.hyd_tension_required_start_kgf = r.tension_kgf ?? null;
       L.hyd_avail_tension_kgf = r.hyd_avail_tension_kgf ?? null;
     }
+    if (L && Number.isFinite(r.gearbox_torque_Nm)) {
+      L.max_gearbox_torque_Nm = Number.isFinite(L.max_gearbox_torque_Nm)
+        ? Math.max(L.max_gearbox_torque_Nm, r.gearbox_torque_Nm)
+        : r.gearbox_torque_Nm;
+    }
   }
 
   return [...byLayer.values()].sort((a, b) => a.layer_no - b.layer_no);
@@ -103,6 +109,7 @@ export function projectHydraulicWraps(rows) {
     hyd_hp_req: r.hyd_hp_used_at_available,
     hyd_hp_sys: r.hyd_elec_input_hp_used,
     hyd_tau_avail_kNm: +(r.hyd_drum_torque_maxP_Nm / 1000).toFixed(1),
+    gearbox_torque_Nm: r.gearbox_torque_Nm,
     hyd_avail_tension_kgf: r.hyd_avail_tension_kgf,
     hyd_drum_rpm_flow: r.hyd_drum_rpm_flow,
     hyd_drum_rpm_power: r.hyd_drum_rpm_power,
@@ -137,6 +144,7 @@ export function renderHydraulicTables(hyLayers, hyWraps, tbodyLayer, tbodyWraps)
       formatHp(r.hyd_hp_req ?? ''),
       formatHp(r.hyd_hp_sys ?? ''),
       formatDecimal(r.hyd_tau_avail_kNm, 1),
+      formatDecimal(r.max_gearbox_torque_Nm, 1),
       formatKgf(r.hyd_tension_theoretical_start_kgf),
       formatKgf(r.hyd_tension_required_start_kgf),
       formatKgf(r.hyd_avail_tension_kgf)
@@ -166,6 +174,7 @@ export function renderHydraulicTables(hyLayers, hyWraps, tbodyLayer, tbodyWraps)
       formatHp(r.hyd_hp_req),
       formatHp(r.hyd_hp_sys),
       formatDecimal(r.hyd_tau_avail_kNm, 1),
+      formatDecimal(r.gearbox_torque_Nm, 1),
       formatKgf(r.hyd_avail_tension_kgf)
     ];
     tr.innerHTML = cells.map(v => `<td>${v}</td>`).join('');
diff --git a/src/js/main.mjs b/src/js/main.mjs
index 5fa30b3..8ff9c9a 100644
--- a/src/js/main.mjs
+++ b/src/js/main.mjs
@@ -339,14 +339,14 @@ const CSV_BUTTON_SPECS = {
     columns: [
       'layer_no', 'layer_dia_in', 'pre_on_drum_m', 'pre_deployed_m',
       'post_on_drum_m', 'post_deployed_m', 'max_tension_theoretical_kgf',
-      'max_tension_required_kgf', 'tau_avail_kNm', 'max_motor_torque_Nm',
+      'max_tension_required_kgf', 'tau_avail_kNm', 'max_gearbox_torque_Nm', 'max_motor_torque_Nm',
       'motor_rpm_at_start', 'line_speed_at_start_mpm',
       'tension_theoretical_start_kgf', 'tension_required_start_kgf', 'avail_tension_kgf'
     ],
     header: [
       'layer_no', 'layer_dia_in', 'pre_on_drum_m', 'pre_deployed_m',
       'post_on_drum_m', 'post_deployed_m', 'max_tension_theoretical_kgf',
-      'max_tension_required_kgf', 'tau_avail_kNm', 'max_motor_torque_Nm',
+      'max_tension_required_kgf', 'tau_avail_kNm', 'max_gearbox_torque_Nm', 'max_motor_torque_Nm',
       'motor_rpm_at_start', 'line_speed_at_start_mpm',
       'tension_theoretical_start_kgf', 'tension_required_start_kgf', 'avail_tension_kgf'
     ],
@@ -357,13 +357,13 @@ const CSV_BUTTON_SPECS = {
     columns: [
       'wrap_no', 'layer_no', 'layer_dia_in', 'wrap_len_in', 'pre_spooled_len_m',
       'spooled_len_m', 'deployed_len_m', 'tension_theoretical_kgf',
-      'tension_required_kgf', 'tau_avail_kNm', 'motor_torque_Nm', 'motor_rpm',
+      'tension_required_kgf', 'tau_avail_kNm', 'gearbox_torque_Nm', 'motor_torque_Nm', 'motor_rpm',
       'line_speed_mpm', 'avail_tension_kgf'
     ],
     header: [
       'wrap_no', 'layer_no', 'layer_dia_in', 'wrap_len_in', 'pre_spooled_len_m',
       'spooled_len_m', 'deployed_len_m', 'tension_theoretical_kgf',
-      'tension_required_kgf', 'tau_avail_kNm', 'motor_torque_Nm', 'motor_rpm',
+      'tension_required_kgf', 'tau_avail_kNm', 'gearbox_torque_Nm', 'motor_torque_Nm', 'motor_rpm',
       'line_speed_mpm', 'avail_tension_kgf'
     ],
     getRows: () => lastElWraps
@@ -374,7 +374,7 @@ const CSV_BUTTON_SPECS = {
       'layer_no', 'layer_dia_in', 'pre_on_drum_m', 'pre_deployed_m',
       'post_on_drum_m', 'post_deployed_m', 'hyd_P_required_psi',
       'hyd_speed_power_mpm', 'hyd_speed_flow_mpm', 'hyd_speed_available_mpm',
-      'hyd_hp_req', 'hyd_hp_sys', 'hyd_tau_avail_kNm',
+      'hyd_hp_req', 'hyd_hp_sys', 'hyd_tau_avail_kNm', 'max_gearbox_torque_Nm',
       'hyd_tension_theoretical_start_kgf', 'hyd_tension_required_start_kgf',
       'hyd_avail_tension_kgf'
     ],
@@ -382,7 +382,7 @@ const CSV_BUTTON_SPECS = {
       'layer_no', 'layer_dia_in', 'pre_on_drum_m', 'pre_deployed_m',
       'post_on_drum_m', 'post_deployed_m', 'hyd_P_required_psi',
       'hyd_speed_power_mpm', 'hyd_speed_flow_mpm', 'hyd_speed_available_mpm',
-      'hyd_hp_req', 'hyd_hp_sys', 'hyd_tau_avail_kNm',
+      'hyd_hp_req', 'hyd_hp_sys', 'hyd_tau_avail_kNm', 'max_gearbox_torque_Nm',
       'hyd_tension_theoretical_start_kgf', 'hyd_tension_required_start_kgf',
       'hyd_avail_tension_kgf'
     ],
@@ -395,14 +395,14 @@ const CSV_BUTTON_SPECS = {
       'spooled_len_m', 'deployed_len_m', 'tension_theoretical_kgf',
       'tension_required_kgf', 'hyd_P_required_psi', 'hyd_speed_power_mpm',
       'hyd_speed_flow_mpm', 'hyd_speed_available_mpm', 'hyd_hp_req',
-      'hyd_hp_sys', 'hyd_tau_avail_kNm', 'hyd_avail_tension_kgf'
+      'hyd_hp_sys', 'hyd_tau_avail_kNm', 'gearbox_torque_Nm', 'hyd_avail_tension_kgf'
     ],
     header: [
       'wrap_no', 'layer_no', 'layer_dia_in', 'wrap_len_in', 'pre_spooled_len_m',
       'spooled_len_m', 'deployed_len_m', 'tension_theoretical_kgf',
       'tension_required_kgf', 'hyd_P_required_psi', 'hyd_speed_power_mpm',
       'hyd_speed_flow_mpm', 'hyd_speed_available_mpm', 'hyd_hp_req',
-      'hyd_hp_sys', 'hyd_tau_avail_kNm', 'hyd_avail_tension_kgf'
+      'hyd_hp_sys', 'hyd_tau_avail_kNm', 'gearbox_torque_Nm', 'hyd_avail_tension_kgf'
     ],
     getRows: () => lastHyWraps
   }
@@ -1198,6 +1198,7 @@ function computeAll() {
     const motor_hp = positiveOr(read('motor_hp'), 0);
     const motor_eff = positiveOr(read('motor_eff'), 1);
     const motor_tmax = read('motor_tmax');
+    const gearbox_max_torque_Nm = read('gearbox_max_torque_Nm');
     const P_per_motor_W = motor_hp * motor_eff * W_PER_HP;
 
     // Hydraulic inputs
@@ -1247,9 +1248,11 @@ function computeAll() {
       const drum_T = tension_N * radius_m;
       const motors_safe = Math.max(motors, 1);
       const gear_product_safe = Math.max(gear_product, 1e-9);
+      const gr2_safe = Math.max(gr2, 1e-9);
       const torque_per_hmotor_required = drum_T / (gear_product_safe * motors_safe);
       const drum_torque_required = torque_per_hmotor_required * gear_product_safe * motors_safe;
       r.torque_Nm = +drum_torque_required.toFixed(1);
+      r.gearbox_torque_Nm = +(drum_torque_required / (gr2_safe * motors_safe)).toFixed(1);
 
       // ----- ELECTRIC per wrap -----
       if (electricEnabled) {
@@ -1417,7 +1420,13 @@ function computeAll() {
     });
 
     // ---- Render tables ----
-    renderElectricTables(lastElLayer, lastElWraps, q('tbody_el_layer'), q('tbody_el_wraps'));
+    renderElectricTables(
+      lastElLayer,
+      lastElWraps,
+      q('tbody_el_layer'),
+      q('tbody_el_wraps'),
+      gearbox_max_torque_Nm
+    );
     renderHydraulicTables(lastHyLayer, lastHyWraps, q('tbody_hy_layer'), q('tbody_hy_wraps'));
 
     renderInputSummary();
-- 
2.43.0
